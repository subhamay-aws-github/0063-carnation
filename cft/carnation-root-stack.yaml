AWSTemplateFormatVersion: '2010-09-09'
Description: >-
   Project Carnation - Root Stack Template To Create a Step Function with DynamoDB table, SNS Topic with subscription 
   and a Lambda function.

Metadata:
  TemplateName: carnation-root-stack.yaml
  TemplateType: Root Stack template to create the other resources
  Version: 1.0.1
  Owner: Subhamay Bhattacharyya
  ProjectName: Project Carnation
  Modification History: 
    - 1.0.0  - April 17, 2023   -- Initial Version.

  Resources: 
    - One SNS Topic with KMS Encryption and Email Subscription.
    - One DynamoDB Table with KMS Encryption.
    - Two Lambda Functions
    - One Step Function
    - One SQS Queue for persisting error events
    - Five CloudWatch Alarms
  StepsToTest: |
    Manualy verify the Stack.
  StepsToCleanup: |
    Stack delete command

  AWS::CloudFormation::Interface:
    ParameterGroups:
    #################################### Project Name and Environment ##############################
    - Label: 
        default: "Project And Environment:"
      Parameters: 
        - ProjectName
        - Environment
    #################################### KMS Key ###################################################
    - Label: 
        default: "KMS Configuration:"
      Parameters: 
        - KmsMasterKeyAlias
        - KmsMasterKeyId
    #################################### SNS with Email Subscription ###############################
    - Label: 
        default: "SNS Configuration:"
      Parameters: 
        - SNSTopicBaseName
        - SNSTopicDisplayName
        - SNSSubscriptionEmail
    #################################### SQS #######################################################
    - Label: 
        default: "SQS Configuration:"
      Parameters: 
        - SQSQueueBaseName
        - DelaySeconds
        - MaximumMessageSize
        - MessageRetentionPeriod
        - ReceiveMessageWaitTimeSeconds
        - VisibilityTimeout
    #################################### DynamoDB Table ############################################
    - Label: 
        default: "DynamoDB Configuration:"
      Parameters: 
      - DynamoDBTableName
      - DynamoDBTablePartitionKey
      - DynamoDBTablePartitionKeyAttributeType
      - DynamoDBTableSortKey
      - DynamoDBTableSortKeyAttributeType
    #################################### Lambda Function ###########################################
    - Label: 
        default: "Lambda Configuration:"
      Parameters: 
        - LambdaExecutionRoleName
        - LambdaExecutionPolicyName
        - LambdaFunctionGenDataBaseName
        - LambdaFunctionPutDataBaseName
        - LambdaFunctionTimeoutSecs
        - LambdaRuntime
        - LambdaFunctionCodeBucket
        - LambdaFunctionGenDataCodeKey
        - LambdaFunctionPutDataCodeKey
        - LambdaReservedConcurrency
    #################################### State Machine #############################################
    - Label: 
        default: "State Machine"
      Parameters: 
        - StepFunctionName
        - StepFunctionExecutionRoleName
        - StepFunctionExecutionPolicyName
    #################################### 1. Lambda Invocations CW Alarm ############################
    - Label: 
        default: "1. CloudWatch Lambda Invocations Alarm Configuration:"
      Parameters: 
        - AlarmNameLambdaInvocations
        - AlarmComparisonOperatorLambdaInvocations
        - AlarmThresholdLambdaInvocations
        - AlarmPeriodInSecondsLambdaInvocations
        - DatapointsToAlarmLambdaInvocations
        - EvaluationPeriodsForLambdaInvocations
    #################################### 2. Lambda Error CW Alarm ##################################
    - Label: 
        default: "2. CloudWatch Lambda Error Alarm Configuration:"
      Parameters: 
        - AlarmNameLambdaErrors
        - AlarmComparisonOperatorLambdaErrors
        - AlarmThresholdLambdaErrors
        - AlarmPeriodInSecondsLambdaErrors
        - DatapointsToAlarmLambdaErrors
        - EvaluationPeriodsForLambdaErrors
    #################################### 3. Lambda Throttles CW Alarm ##############################
    - Label: 
        default: "3. CloudWatch Lambda Throttles Alarm Configuration:"
      Parameters: 
        - AlarmNameLambdaThrottles
        - AlarmComparisonOperatorLambdaThrottles
        - AlarmThresholdLambdaThrottles
        - AlarmPeriodInSecondsLambdaThrottles
        - DatapointsToAlarmLambdaThrottles
        - EvaluationPeriodsForLambdaThrottles
    #################################### 4. Lambda Duration CW Alarm ###############################
    - Label: 
        default: "4. CloudWatch Lambda Duration Alarm Configuration:"
      Parameters: 
        - AlarmNameLambdaDuration
        - AlarmComparisonOperatorLambdaDuration
        - AlarmThresholdLambdaDuration
        - AlarmPeriodInSecondsLambdaDuration
        - DatapointsToAlarmLambdaDuration
        - EvaluationPeriodsForLambdaDuration
    #################################### 5. Lambda Concurrent Executions CW Alarm ##################
    - Label: 
        default: "5. CloudWatch Lambda Concurrent Executions Alarm Configuration:"
      Parameters: 
        - AlarmNameLambdaConcurrentExecutions
        - AlarmComparisonOperatorLambdaConcurrentExecutions
        - AlarmThresholdLambdaConcurrentExecutions
        - AlarmPeriodInSecondsLambdaConcurrentExecutions
        - DatapointsToAlarmLambdaConcurrentExecutions
        - EvaluationPeriodsForLambdaConcurrentExecutions
    ParameterLabels:
      ################################## Project Name and Environment ##############################
      ProjectName:
        default: "Project Name."
      Environment:
        default: "Environment Name."
      ################################## KMS Key ###################################################
      KmsMasterKeyAlias:
        default: "KMS Key Alias."
      KmsMasterKeyId:
        default: "KMS Key Id."
      ################################## SNS Topic With Email Subscription #########################
      SNSTopicBaseName:
        default: "SNS Topic."
      SNSTopicDisplayName:
        default: "SNS Display Name."
      SNSSubscriptionEmail:
        default: "Email Subscription."
      ################################## SQS Queue #################################################
      SQSQueueBaseName:
        default: "SQS Queue Base Name."
      DelaySeconds:
        default: "Delay Seconds."
      MaximumMessageSize:
        default: "Maximum Message Size."
      MessageRetentionPeriod: 
        default: "Message Retention Period."
      ReceiveMessageWaitTimeSeconds: 
        default: "Received Message Wait Time Seconds."
      VisibilityTimeout:
        default: "Visibility Timeout."
      ################################## DynamoDB Table ############################################
      DynamoDBTableName: 
        default: "DynamoDB Table."
      DynamoDBTablePartitionKey:
        default: "Partition Key."
      DynamoDBTablePartitionKeyAttributeType: 
        default: "Partition Key Datatype."
      DynamoDBTableSortKeyAttributeType: 
        default: "Sort Key Datatype."
      ################################## Lambda Function ###########################################
      LambdaExecutionRoleName:
        default: "Lambda Execution Role."
      LambdaExecutionPolicyName: 
        default: "Lambda Excution Policy."
      LambdaFunctionGenDataBaseName:
        default: "Lambda Function Name To Generate Random Data."
      LambdaFunctionPutDataBaseName:
        default: "Lambda Function Name To Insert Into A DynamoDB Table."
      LambdaFunctionTimeoutSecs:
        default: "Lambda Function Timeout."
      LambdaRuntime:
        default: "Lambda Function Runtime."
      LambdaFunctionCodeBucket:
        default: "Lambda Code S3 Bucket."
      LambdaFunctionGenDataCodeKey: 
        default: "Lambda Code Zip File Generate Ramdom Data."
      LambdaFunctionPutDataCodeKey: 
        default: "Lambda Code Zip File To Insert Into A DynamoDB Table."
      LambdaReservedConcurrency:
        default: "Lambda Reserved Concurrency."
      #################################### State Machine ###########################################
      StepFunctionName:
        default: "State Machine Name:"
      StepFunctionExecutionRoleName:
        default: "State Machine Role Name:"
      StepFunctionExecutionPolicyName: 
        default: "State Macine Excution Policy:"
      ################################## 1. Lambda Invocations CW Alarm ############################
      AlarmNameLambdaInvocations:
        default: "Lambda Invocations Alarm."
      AlarmComparisonOperatorLambdaInvocations: 
        default: "Lambda Invocations Alarm Condition."
      AlarmThresholdLambdaInvocations: 
        default: "Lambda Invocations Alarm Threshold."
      AlarmPeriodInSecondsLambdaInvocations: 
        default: "Lambda Invocations Alarm Period."
      DatapointsToAlarmLambdaInvocations:  
        default: "Lambda Invocations Alarm Datapoints."
      EvaluationPeriodsForLambdaInvocations:
        default: "Lambda Invocations Alarm Evaluation Periods."
      #################################### 2. Lambda Error CW Alarm ################################
      AlarmNameLambdaErrors:
        default: "Lambda Errors Alarm."
      AlarmComparisonOperatorLambdaErrors: 
        default: "Lambda Errors Alarm Condition."
      AlarmThresholdLambdaErrors: 
        default: "Lambda Errors Alarm Threshold."
      AlarmPeriodInSecondsLambdaErrors: 
        default: "Lambda Errors Alarm Period."
      DatapointsToAlarmLambdaErrors:  
        default: "Lambda Errors Alarm Datapoints."
      EvaluationPeriodsForLambdaErrors:
        default: "Lambda Errors Alarm Evaluation Periods."
      ################################## 3. Lambda Throttles CW Alarm ##############################
      AlarmNameLambdaThrottles:
        default: "Lambda Throttles Alarm."
      AlarmComparisonOperatorLambdaThrottles: 
        default: "Lambda Throttles Alarm Condition."
      AlarmThresholdLambdaThrottles: 
        default: "Lambda Throttles Alarm Threshold."
      AlarmPeriodInSecondsLambdaThrottles: 
        default: "Lambda Throttles Alarm Period."
      DatapointsToAlarmLambdaThrottles:  
        default: "Lambda Throttles Alarm Datapoints."
      EvaluationPeriodsForLambdaThrottles:
        default: "Lambda Throttles Alarm Evaluation Periods."
      ################################## 4. Lambda Duration CW Alarm ###############################
      AlarmNameLambdaDuration:
        default: "Lambda Duration Alarm."
      AlarmComparisonOperatorLambdaDuration: 
        default: "Lambda Duration Alarm Condition."
      AlarmThresholdLambdaDuration: 
        default: "Lambda Duration Alarm Threshold."
      AlarmPeriodInSecondsLambdaDuration: 
        default: "Lambda Duration Alarm Period."
      DatapointsToAlarmLambdaDuration:  
        default: "Lambda Duration Alarm Datapoints."
      EvaluationPeriodsForLambdaDuration:
        default: "Lambda Duration Alarm Evaluation Periods."
      ################################## 5. Lambda Concurrent Executions CW Alarm ##################
      AlarmNameLambdaConcurrentExecutions:
        default: "Lambda Concurrent Executions Alarm."
      AlarmComparisonOperatorLambdaConcurrentExecutions: 
        default: "Lambda Concurrent Executions Alarm Condition."
      AlarmThresholdLambdaConcurrentExecutions: 
        default: "Lambda Concurrent Executions Alarm Threshold."
      AlarmPeriodInSecondsLambdaConcurrentExecutions: 
        default: "Lambda Concurrent Executions Alarm Period."
      DatapointsToAlarmLambdaConcurrentExecutions:  
        default: "Lambda Concurrent Executions Alarm Datapoints."
      EvaluationPeriodsForLambdaConcurrentExecutions:
        default: "Lambda Concurrent Executions Alarm Evaluation Periods."
Parameters:
  ###################################### Project Name and Environment ##############################
  ProjectName:
    Default: carnation
    Description: "The Project Name."
    Type: String
    MinLength: 5
    MaxLength: 30
    AllowedPattern: "[a-z]*"
    ConstraintDescription: "The length should be between 5 and 30, must contain only lowercase alphabets."
  Environment:
    Default: devl
    Description: "The Environment Name."
    Type: String
    AllowedValues: ["devl", "test", "prod"]
    ConstraintDescription: "The Environment must be devl / test or prod"
  ###################################### KMS Key ###################################################
  KmsMasterKeyAlias:
    Default: "SB-KMS"
    Description: "The KMS Master Key Alias To Be Used For Server Side Encryption."
    Type: String
    MinLength: 5
    MaxLength: 20
    AllowedPattern: "[a-zA-Z0-9-]*"
    ConstraintDescription: "The length of the KMS Key Alias should be beteen 5 and 20 and can only contain lowercase alphanumeric characters and dash."
  KmsMasterKeyId:
    Default: "e4c733c5-9fbe-4a90-bda1-6f0362bc9b89"
    Description: "The KMS Key Id Used For Encryption."
    Type: String
    MinLength: 36
    MaxLength: 36
    AllowedPattern: "[a-z0-9-]*"
    ConstraintDescription: "The length of the KMS Key Id should be 36 and must be lowercase alphabets, numbers and dash."
  ###################################### SNS Topic With Email Subscription #########################
  SNSTopicBaseName:
    Default: "carnation-sns-topic"
    Description: "The Base Name Of The Sns Topic. The Region And Environment Will Be Added As Suffix By The Template."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: "[a-z][a-z0-9-]*"
    ConstraintDescription: "The length should be between 10 and 40, must contain only lowercase letter, number, dash, dot and should start with a letter."
  SNSTopicDisplayName:
    Default: "Carnation CloudWatch Alarm For Lambda."
    Description: "The SNS Topic Display Name."
    Type: String
    MinLength: 30
    MaxLength: 200
    AllowedPattern: "[a-zA-Z0-9-. _]*"
    ConstraintDescription: "The length should be between 30 and 200, must alphanumeric character, space, dot dash or underscore."
  SNSSubscriptionEmail:
    Default: "subhamay.aws@gmail.com"
    Description: "The Subscription Email For The Sns Topic."
    Type: String
    MinLength: 10
    MaxLength: 100
    AllowedPattern: "[a-zA-Z0-9-.@_]*"
    ConstraintDescription:  "The length should be between 10 and 100, must be a valid email id."
  ###################################### SQS Queue #################################################
  SQSQueueBaseName:
    Default: "carnation-sqs-queue"
    Description: "The Base Name Of The Sqs Queue (Dead Letter Quque). The Region And Environment Will Be Added As Suffix By The Template."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: "[a-z][a-z0-9-]*"
    ConstraintDescription: "The length should be between 10 and 40, must contain only lowercase letter, number, dash, dot and should start with a letter."
  DelaySeconds:
    Type: Number
    Description: "Delay Seconds."
    Default: 0
    MinValue: 0
    MaxValue: 900
  MaximumMessageSize:
    Type: Number
    Description: "Maximum Message Size."
    Default: 262144
    MinValue: 1024
    MaxValue: 262144
  MessageRetentionPeriod:
    Type: Number
    Description: "Message Retention Period."
    Default: 345600
    MinValue: 60
    MaxValue: 1209600
  ReceiveMessageWaitTimeSeconds:
    Type: Number
    Description: "Received Message Wait Time Seconds."
    Default: 5
    MinValue: 0
    MaxValue: 20
  VisibilityTimeout:
    Type: Number
    Description: "Visibility Timeout."
    Default: 0
    MinValue: 0
    MaxValue: 43200  
  ###################################### DynamoDB Table ############################################
  DynamoDBTableName:
    Default: carnation-table
    Description: "The Name Of The Dynamodb Table Used For Iterating Using Step Function Map State."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: "[a-z][a-z0-9-]*"
    ConstraintDescription: "The length should be between 10 and 40, must contain only lowercase letter, number, dash and should start with a letter."
  DynamoDBTablePartitionKey:
    Default: sequenceNo
    Description: "The Name Of The Dynamodb Partition Key."
    Type: String
    MinLength: 2
    MaxLength: 30
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9\-_]*'
    ConstraintDescription: "Must begin with a letter and contain only alphanumeric characters."
  DynamoDBTablePartitionKeyAttributeType:
    Default: "N"
    Description: "The Datatype Of The Dynamodb Partition Key."
    Type: String
    AllowedValues: ["N", "S", "B"]
    ConstraintDescription: "The datatype should be either N (Number), S (String) or B (Binary)"
  DynamoDBTableSortKey:
    Default: generatedUnixTime
    Description: "The Name Of The Dynamodb Partition Key."
    Type: String
    MinLength: 2
    MaxLength: 30
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9\-_]*'
    ConstraintDescription: "Must begin with a letter and contain only alphanumeric characters."
  DynamoDBTableSortKeyAttributeType:
    Default: "N"
    Description: "The Datatype Of The Dynamodb Partition Key."
    Type: String
    AllowedValues: ["N", "S", "B"]
    ConstraintDescription: "the Datatype Should Be Either N (number), S (string) Or B (binary)"
  ###################################### Lambda Function ###########################################
  LambdaExecutionRoleName:
    Default: carnation-lambda-role
    Description: "The Execution Role Of The Lambda Function."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 5 and 255 characters long and begin with a letter and can contain number or hyphen (-)."
  LambdaExecutionPolicyName:
    Default: carnation-lambda-policy
    Description: "The Execution Policy Attached To The Lambda Execution Role."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 5 and 255 characters long and begin with a letter and can contain number or hyphen (-)."
  LambdaFunctionGenDataBaseName:
    Default: carnation-generate-data
    Description: "The Base Name The Lambda Function. The Region And Environment Will Be Added As Suffix By The Template."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 5 and 255 characters long and begin with a letter and can contain number or hyphen (-)."
  LambdaFunctionPutDataBaseName:
    Default: carnation-insert-data
    Description: "The Base Name The Lambda Function. The Region And Environment Will Be Added As Suffix By The Template."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 5 and 255 characters long and begin with a letter and can contain number or hyphen (-)."
  LambdaFunctionTimeoutSecs:
    Default: 900
    Description: "The Lambda Function Timeout Period (In Seconds)"
    Type: Number
    MinValue: 3
    MaxValue: 900
    ConstraintDescription: must be between 3 and 900 seconds.
  LambdaRuntime:
    Default: python3.8
    Description: "Lambda Runtime (Python 3.7, 3.8 or 3.9)"
    Type: String
    AllowedValues: [python3.7 ,python3.8, python3.9]
    ConstraintDescription: "The Lambda runtime should be either Python 3.7, 3.8 or 3.9"
  LambdaFunctionCodeBucket:
    Default: subhamay-projects-repository-us-east-1
    Description: "S3 Bucket Storing The Lambda Code."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: "[a-z][a-z0-9-.]*"
    ConstraintDescription: "The length should be between 3 and 63, must contain only lowercase letter,numbers,dash, dot and should start with a letter."
  LambdaFunctionGenDataCodeKey:
    Default: 0063-carnation/code/python/carnation_gen_data.zip
    Description: "The Zip File Name Containing The Lambda Code."
    Type: String
    MinLength: 10
    MaxLength: 100
    AllowedPattern: "[a-zA-Z0-9-/_.]*"
    ConstraintDescription: "The length should be between 10 and 100, must contain only lowercase letter,numbers,dash, dot, underscore"
  LambdaFunctionPutDataCodeKey:
    Default: 0063-carnation/code/python/carnation_put_data.zip
    Description: "The Zip File Name Containing The Lambda Code."
    Type: String
    MinLength: 10
    MaxLength: 100
    AllowedPattern: "[a-zA-Z0-9-/_.]*"
    ConstraintDescription: "The length should be between 10 and 100, must contain only lowercase letter,numbers,dash, dot, underscore"
  LambdaReservedConcurrency:
    Default: 2
    Description: "Lambda Reserved Concurrency"
    Type: Number
    MinValue: 0
    MaxValue: 5
  #################################### State Machine ###########################################
  StepFunctionName:
    Default: carnation-state-machine
    Description: "The Base Name The Lambda Function. The Region And Environment Will Be Added As Suffix By The Template."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 5 and 255 characters long and begin with a letter and can contain number or hyphen (-)."
  StepFunctionExecutionRoleName:
    Default: carnation-step-function-role
    Description: "The Execution Role Of The State Machine."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 5 and 255 characters long and begin with a letter and can contain number or hyphen (-)."
  StepFunctionExecutionPolicyName:
    Default: carnation-step-function-policy
    Description: "The Execution Policy Of The State Machine."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 5 and 255 characters long and begin with a letter and can contain number or hyphen (-)."
  ###################################### 1. Lambda Invocations CW Alarm ############################
  AlarmNameLambdaInvocations:
    Default: carnation-lambda-invocations-alarm
    Description: "The Lambda Invocations Alarm Name. The Region And Environment Will Be Added As Suffix By The Template.."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 10 and 50 characters long and begin with a letter and can contain lowercase letter, number or hyphen (-)."
  AlarmThresholdLambdaInvocations:
    Default: 5
    Description: "The Cloudwatch Alarm Threshold. Number Of Lambda Executions After Which The Alarm Will Be Triggered."
    Type: Number
    MinValue: 1
    MaxValue: 99
    ConstraintDescription: must be between 70 and 99.
  AlarmPeriodInSecondsLambdaInvocations:
    Default: 60
    Description: "The Period, In Seconds, Over Which The Statistic Is Applied."
    Type: Number
    MinValue: 10
    MaxValue: 3600
    ConstraintDescription: "Must be between 10 and 3600 seconds."
  DatapointsToAlarmLambdaInvocations: 
    Default: 1
    Description: "The CloudWatch Alarm Threshold."
    Type: Number
    MinValue: 1
    MaxValue: 10
    ConstraintDescription: must be between 1 and 10 seconds.
  EvaluationPeriodsForLambdaInvocations: 
    Default: 1
    Description: "The Number Of Periods Over Which Data Is Compared To The Specified Threshold."
    Type: Number
    MinValue: 1
    MaxValue: 3
    ConstraintDescription: "Must be between 1 and 3 Hours."
  AlarmComparisonOperatorLambdaInvocations:
    Default: "GreaterThanOrEqualToThreshold"
    Description: "The Lambda Invocations Alarm Comparison Operator."
    Type: String
    AllowedValues: [GreaterThanThreshold, GreaterThanOrEqualToThreshold, LessThanThreshold, LessThanOrEqualToThreshold]
  ###################################### 2. Lambda Error CW Alarm ##################################
  AlarmNameLambdaErrors:
    Default: carnation-lambda-errors
    Description: "The Lambda Errors Alarm Name. The Region And Environment Will Be Added As Suffix By The Template."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 10 and 50 characters long and begin with a letter and can contain lowercase letter, number or hyphen (-)."
  AlarmThresholdLambdaErrors:
    Default: 2
    Description: "The Cloudwatch Alarm Threshold.Number Of Lambda Executions After Which The Alarm Will Be Triggered."
    Type: Number
    MinValue: 1
    MaxValue: 99
    ConstraintDescription: "Must be between 1 and 99."
  AlarmPeriodInSecondsLambdaErrors:
    Default: 60
    Description: "The Period, In Seconds, Over Which The Statistic Is Applied."
    Type: Number
    MinValue: 10
    MaxValue: 3600
    ConstraintDescription: "Must be between 10 and 3600 seconds."
  DatapointsToAlarmLambdaErrors: 
    Default: 1
    Description: "The CloudWatch Alarm Threshold."
    Type: Number
    MinValue: 1
    MaxValue: 10
    ConstraintDescription: "Must be between 1 and 10 seconds."
  EvaluationPeriodsForLambdaErrors: 
    Default: 1
    Description: "The Number Of Periods Over Which Data Is Compared To The Specified Threshold."
    Type: Number
    MinValue: 1
    MaxValue: 3
    ConstraintDescription: "Must be between 1 and 3 Hours."
  AlarmComparisonOperatorLambdaErrors:
    Default: "GreaterThanOrEqualToThreshold"
    Description: "The Lambda Errors Alarm Comparison Operator."
    Type: String
    AllowedValues: [GreaterThanThreshold, GreaterThanOrEqualToThreshold, LessThanThreshold, LessThanOrEqualToThreshold]
  ###################################### 3. Lambda Throttles CW Alarm ##############################
  AlarmNameLambdaThrottles:
    Default: carnation-lambda-throttles
    Description: "The Lambda Throttles Alarm Name. The Region And Environment Will Be Added As Suffix By The Template."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 10 and 50 characters long and begin with a letter and can contain lowercase letter, number or hyphen (-)."
  AlarmThresholdLambdaThrottles:
    Default: 3
    Description: "The Cloudwatch Alarm Threshold.The Number Of Lambda Throttles After Which The Alarm Will Be Triggered."
    Type: Number
    MinValue: 1
    MaxValue: 10
    ConstraintDescription: "Must be between 1 and 10."
  AlarmPeriodInSecondsLambdaThrottles:
    Default: 60
    Description: "The Period, In Seconds, Over Which The Statistic Is Applied."
    Type: Number
    MinValue: 10
    MaxValue: 3600
    ConstraintDescription: "Must be between 10 and 3600 seconds."
  DatapointsToAlarmLambdaThrottles: 
    Default: 1
    Description: "The CloudWatch Alarm Threshold."
    Type: Number
    MinValue: 1
    MaxValue: 10
    ConstraintDescription: "Must be between 1 and 10 seconds."
  EvaluationPeriodsForLambdaThrottles: 
    Default: 1
    Description: "The Number Of Periods Over Which Data Is Compared To The Specified Threshold."
    Type: Number
    MinValue: 1
    MaxValue: 3
    ConstraintDescription: "Must be between 1 and 3 Hours."
  AlarmComparisonOperatorLambdaThrottles:
    Default: "GreaterThanOrEqualToThreshold"
    Description: "The Lambda Throttles Alarm Comparison Operator."
    Type: String
    AllowedValues: [GreaterThanThreshold, GreaterThanOrEqualToThreshold, LessThanThreshold, LessThanOrEqualToThreshold]
  ###################################### 4. Lambda Duration CW Alarm ###############################
  AlarmNameLambdaDuration:
    Default: carnation-duration
    Description: "The Lambda Duration Alarm Name. The Region And Environment Will Be Added As Suffix By The Template."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 10 and 50 characters long and begin with a letter and can contain lowercase letter, number or hyphen (-)."
  AlarmThresholdLambdaDuration:
    Default: 100
    Description: "The CloudWatch Alarm Threshold.The Number Of Milliseconds The Alarm Will Be Triggered."
    Type: Number
    MinValue: 0
    MaxValue: 900000
    ConstraintDescription: "Must be between 0 and 900000."
  AlarmPeriodInSecondsLambdaDuration:
    Default: 900
    Description: "The Period, In Seconds, Over Which The Statistic Is Applied."
    Type: Number
    MinValue: 10
    MaxValue: 3600
    ConstraintDescription: "Must be between 10 and 3600 seconds."
  DatapointsToAlarmLambdaDuration: 
    Default: 1
    Description: "The CloudWatch Alarm Threshold."
    Type: Number
    MinValue: 1
    MaxValue: 10
    ConstraintDescription: "Must be between 1 and 10 seconds."
  EvaluationPeriodsForLambdaDuration: 
    Default: 1
    Description: "The Number Of Periods Over Which Data Is Compared To The Specified Threshold."
    Type: Number
    MinValue: 1
    MaxValue: 3
    ConstraintDescription: "Must be between 1 and 3 Hours."
  AlarmComparisonOperatorLambdaDuration:
    Default: "GreaterThanOrEqualToThreshold"
    Description: "The Lambda Duration Alarm Comparison Operator."
    Type: String
    AllowedValues: [GreaterThanThreshold, GreaterThanOrEqualToThreshold, LessThanThreshold, LessThanOrEqualToThreshold]
  ###################################### 5. Lambda Concurrent Executions CW Alarm ##################
  AlarmNameLambdaConcurrentExecutions:
    Default: carnation-conc-exec
    Description: "The Lambda Concurrent Executions Alarm Name. The Region And Environment Will Be Added As Suffix By The Template."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 10 and 50 characters long and begin with a letter and can contain lowercase letter, number or hyphen (-)."
  AlarmThresholdLambdaConcurrentExecutions:
    Default: 3
    Description: "The CloudWatch Alarm Threshold.After The Number Of Concurrent Executions The Alarm Will Be Triggered."
    Type: Number
    MinValue: 0
    MaxValue: 10
    ConstraintDescription: "Must be between 0 and 10."
  AlarmPeriodInSecondsLambdaConcurrentExecutions:
    Default: 60
    Description: "The Period, In Seconds, Over Which The Statistic Is Applied."
    Type: Number
    MinValue: 10
    MaxValue: 3600
    ConstraintDescription: "Must be between 10 and 3600 seconds."
  DatapointsToAlarmLambdaConcurrentExecutions: 
    Default: 1
    Description: "The CloudWatch Alarm Threshold."
    Type: Number
    MinValue: 1
    MaxValue: 10
    ConstraintDescription: "Must be between 1 and 10 seconds."
  EvaluationPeriodsForLambdaConcurrentExecutions: 
    Default: 1
    Description: "The Number Of Periods Over Which Data Is Compared To The Specified Threshold."
    Type: Number
    MinValue: 1
    MaxValue: 3
    ConstraintDescription: "Must be between 1 and 3 Hours."
  AlarmComparisonOperatorLambdaConcurrentExecutions:
    Default: "GreaterThanOrEqualToThreshold"
    Description: "The Lambda Concurrent Executions Alarm Comparison Operator."
    Type: String
    AllowedValues: [GreaterThanThreshold, GreaterThanOrEqualToThreshold, LessThanThreshold, LessThanOrEqualToThreshold]
Resources:
  ###################################### SNS Topic With Email Subscription #########################
  CarnationSNSTopic:
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://subhamay-projects-repository-us-east-1.s3.amazonaws.com/0063-carnation/cft/nested-stacks/sns-stack.yaml
      Parameters:  
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        TopicBaseName: !Ref SNSTopicBaseName
        TopicDisplayName: !Ref SNSTopicDisplayName 
        SubscriptionEmail: !Ref SNSSubscriptionEmail
        KmsMasterKeyAlias: !Ref KmsMasterKeyAlias
      TimeoutInMinutes: 15
  ###################################### SQS Queue #################################################
  CarnationSQSQueue:
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://subhamay-projects-repository-us-east-1.s3.amazonaws.com/0063-carnation/cft/nested-stacks/sqs-stack.yaml
      Parameters:  
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        QueueName: !Ref SQSQueueBaseName
        DelaySeconds: !Ref DelaySeconds 
        KmsMasterKeyAlias: !Ref KmsMasterKeyAlias
        MaximumMessageSize: !Ref MaximumMessageSize
        MessageRetentionPeriod: !Ref MessageRetentionPeriod
        ReceiveMessageWaitTimeSeconds: !Ref ReceiveMessageWaitTimeSeconds
        VisibilityTimeout: !Ref VisibilityTimeout
      TimeoutInMinutes: 15
  ###################################### DynamoDB Table ############################################
  CarnationDynamoDBTable:
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://subhamay-projects-repository-us-east-1.s3.amazonaws.com/0063-carnation/cft/nested-stacks/dynamodb-stack.yaml
      Parameters:  
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        DynamoDBTableName: !Ref DynamoDBTableName
        DynamoDBTablePartitionKey: !Ref DynamoDBTablePartitionKey 
        DynamoDBTablePartitionKeyAttributeType: !Ref DynamoDBTablePartitionKeyAttributeType
        DynamoDBTableSortKey: !Ref DynamoDBTableSortKey
        DynamoDBTableSortKeyAttributeType: !Ref DynamoDBTableSortKeyAttributeType
        DynamoDBTableKmsMasterKeyAlias: !Ref KmsMasterKeyAlias
      TimeoutInMinutes: 15
  ###################################### Lambda And State Machine Execution Role ###################
  CarnationIAMExecutionRole:
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://subhamay-projects-repository-us-east-1.s3.amazonaws.com/0063-carnation/cft/nested-stacks/iam-role-stack.yaml
      Parameters:  
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        LambdaExecutionRoleName: !Ref LambdaExecutionRoleName
        LambdaExecutionPolicyName: !Ref LambdaExecutionPolicyName
        LambdaFunctionNameOne: !Ref LambdaFunctionGenDataBaseName
        LambdaFunctionNameTwo: !Ref LambdaFunctionPutDataBaseName
        StepFunctionExecutionRoleName: !Ref StepFunctionExecutionRoleName
        StepFunctionExecutionPolicyName: !Ref StepFunctionExecutionPolicyName
        SNSTopicBaseName: !Ref SNSTopicBaseName
        SQSQueueBaseName: !Ref SQSQueueBaseName
        KmsMasterKeyId: !Ref KmsMasterKeyId
      TimeoutInMinutes: 15
  ###################################### Lambda Function One #######################################
  CarnationGenDataLambdaFunction:
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://subhamay-projects-repository-us-east-1.s3.amazonaws.com/0063-carnation/cft/nested-stacks/lambda-function-stack.yaml
      Parameters:  
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        LambdaRuntime: !Ref LambdaRuntime
        LambdaFunctionTimeoutSecs: !Ref LambdaFunctionTimeoutSecs
        LambdaFunctionName: !Ref LambdaFunctionGenDataBaseName
        LambdaFunctionDescription: "Carnation Lambda To Generate Some Random Data"
        LambdaFunctionCodeBucket: !Ref LambdaFunctionCodeBucket
        LambdaFunctionCodeKey: !Ref LambdaFunctionGenDataCodeKey
        LambdaExecutionRoleArn: !GetAtt CarnationIAMExecutionRole.Outputs.LambdaExecutionRoleArn
        LambdaReservedConcurrency: !Ref LambdaReservedConcurrency
        LambdaHandlerPath: "carnation_gen_data.handler"
        DynamoDBTableName: "not-applicable"
        SQSQueueURL: !GetAtt CarnationSQSQueue.Outputs.SQSQueueURL
      TimeoutInMinutes: 15
  ###################################### Lambda Function Two #######################################
  CarnationPutDataLambdaFunction:
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://subhamay-projects-repository-us-east-1.s3.amazonaws.com/0063-carnation/cft/nested-stacks/lambda-function-stack.yaml
      Parameters:  
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        LambdaRuntime: !Ref LambdaRuntime
        LambdaFunctionTimeoutSecs: !Ref LambdaFunctionTimeoutSecs
        LambdaFunctionName: !Ref LambdaFunctionPutDataBaseName
        LambdaFunctionDescription: "Lambda Function To Insert Random Data Into A DynamoDB Table."
        LambdaFunctionCodeBucket: !Ref LambdaFunctionCodeBucket
        LambdaFunctionCodeKey: !Ref LambdaFunctionPutDataCodeKey
        LambdaExecutionRoleArn: !GetAtt CarnationIAMExecutionRole.Outputs.LambdaExecutionRoleArn
        LambdaReservedConcurrency: !Ref LambdaReservedConcurrency
        LambdaHandlerPath: "carnation_put_data.handler"
        DynamoDBTableName: !Sub "${DynamoDBTableName}-${Environment}-${AWS::Region}"
        SQSQueueURL: !GetAtt CarnationSQSQueue.Outputs.SQSQueueURL
      TimeoutInMinutes: 15
  ###################################### State Machine #############################################
  CarnationStateMachine:
    Type: AWS::StepFunctions::StateMachine
    Properties:
      StateMachineName: !Sub '${StepFunctionName}-${Environment}-${AWS::Region}'
      DefinitionS3Location:
        Bucket: subhamay-projects-repository-us-east-1
        Key: 0063-carnation/cft/state-machine/state-machine.json
      DefinitionSubstitutions:
        GenDataLambda: !GetAtt CarnationGenDataLambdaFunction.Outputs.LambdaFunctionArn
        PutDataLambda: !GetAtt CarnationPutDataLambdaFunction.Outputs.LambdaFunctionArn
        SQSQueueURL: !GetAtt CarnationSQSQueue.Outputs.SQSQueueURL
      RoleArn: !GetAtt CarnationIAMExecutionRole.Outputs.StepFunctionExecutionRoleArn
      Tags: 
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key:  Environment
          Value: !Ref Environment
  ###################################### CloudWatch Alarms #########################################
  CarnationCloudWatchAlarms:
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://subhamay-projects-repository-us-east-1.s3.amazonaws.com/0063-carnation/cft/nested-stacks/cloudwatch-stack.yaml
      Parameters:  
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        LambdaFunctionName: !Sub '${LambdaFunctionPutDataBaseName}-${Environment}-${AWS::Region}'
        SNSTopicName: !Sub '${SNSTopicBaseName}-${Environment}-${AWS::Region}'
        AlarmNameLambdaInvocations: !Ref AlarmNameLambdaInvocations
        AlarmThresholdLambdaInvocations: !Ref AlarmThresholdLambdaInvocations
        AlarmPeriodInSecondsLambdaInvocations: !Ref AlarmPeriodInSecondsLambdaInvocations
        DatapointsToAlarmLambdaInvocations: !Ref DatapointsToAlarmLambdaInvocations
        EvaluationPeriodsForLambdaInvocations: !Ref EvaluationPeriodsForLambdaInvocations
        AlarmComparisonOperatorLambdaInvocations: !Ref AlarmComparisonOperatorLambdaInvocations
        AlarmNameLambdaErrors: !Ref AlarmNameLambdaErrors
        AlarmThresholdLambdaErrors: !Ref AlarmThresholdLambdaErrors
        AlarmPeriodInSecondsLambdaErrors: !Ref AlarmPeriodInSecondsLambdaErrors
        DatapointsToAlarmLambdaErrors: !Ref DatapointsToAlarmLambdaErrors
        EvaluationPeriodsForLambdaErrors: !Ref EvaluationPeriodsForLambdaErrors
        AlarmComparisonOperatorLambdaErrors: !Ref AlarmComparisonOperatorLambdaErrors
        AlarmNameLambdaThrottles: !Ref AlarmNameLambdaThrottles
        AlarmThresholdLambdaThrottles: !Ref AlarmThresholdLambdaThrottles
        AlarmPeriodInSecondsLambdaThrottles: !Ref AlarmPeriodInSecondsLambdaThrottles
        DatapointsToAlarmLambdaThrottles: !Ref DatapointsToAlarmLambdaThrottles
        EvaluationPeriodsForLambdaThrottles: !Ref EvaluationPeriodsForLambdaThrottles
        AlarmComparisonOperatorLambdaThrottles: !Ref AlarmComparisonOperatorLambdaThrottles
        AlarmNameLambdaDuration: !Ref AlarmNameLambdaDuration
        AlarmThresholdLambdaDuration: !Ref AlarmThresholdLambdaDuration
        AlarmPeriodInSecondsLambdaDuration: !Ref AlarmPeriodInSecondsLambdaDuration
        DatapointsToAlarmLambdaDuration: !Ref DatapointsToAlarmLambdaDuration
        EvaluationPeriodsForLambdaDuration: !Ref EvaluationPeriodsForLambdaDuration
        AlarmComparisonOperatorLambdaDuration: !Ref AlarmComparisonOperatorLambdaDuration
        AlarmNameLambdaConcurrentExecutions: !Ref AlarmNameLambdaConcurrentExecutions
        AlarmThresholdLambdaConcurrentExecutions: !Ref AlarmThresholdLambdaConcurrentExecutions
        AlarmPeriodInSecondsLambdaConcurrentExecutions: !Ref AlarmPeriodInSecondsLambdaConcurrentExecutions
        DatapointsToAlarmLambdaConcurrentExecutions: !Ref DatapointsToAlarmLambdaConcurrentExecutions
        EvaluationPeriodsForLambdaConcurrentExecutions: !Ref EvaluationPeriodsForLambdaConcurrentExecutions
        AlarmComparisonOperatorLambdaConcurrentExecutions: !Ref AlarmComparisonOperatorLambdaConcurrentExecutions
      TimeoutInMinutes: 5
Outputs:
  CarnationSNSTopicArn:
    Description: Carnation SNS Topic Arn
    Value: !GetAtt CarnationSNSTopic.Outputs.SNSTopicArn
  CarnationSNSSubscriptionArn:
    Description: Carnation SNS Topc Subscription Arn
    Value: !GetAtt CarnationSQSQueue.Outputs.SQSQueueArn
  CarnationSNSSubscriptionURL:
    Description: Carnation SNS Topc Subscription Arn
    Value: !GetAtt CarnationSQSQueue.Outputs.SQSQueueURL
  CarnationSSQSArn:
    Description: Carnation SQS Queue Arn
    Value: !GetAtt CarnationSNSTopic.Outputs.SNSSubscriptionArn
  CarnationDynamoDBTableArn: 
    Description: Carnation DynamoDB Table Arn
    Value: !GetAtt CarnationDynamoDBTable.Outputs.DynamoDBTableArn
  CarnationLambdaExecutionRoleArn:
    Description: Carnation Lambda Execution Role Arn
    Value: !GetAtt CarnationIAMExecutionRole.Outputs.LambdaExecutionRoleArn
  CarnationStepFunctionExecutionRoleArn:
    Description: Carnation State Function Execution Role Arn
    Value: !GetAtt CarnationIAMExecutionRole.Outputs.StepFunctionExecutionRoleArn
  CarnationGenDataLambdaFunctionArn: 
    Description: Carnation Seed DynamoDB Table Lambda Function Arn
    Value: !GetAtt CarnationGenDataLambdaFunction.Outputs.LambdaFunctionArn
  CarnationPutDataLambdaFunctionArn: 
    Description: Carnation Insert Data Into DynamoDB Table Lambda Function Arn
    Value: !GetAtt CarnationPutDataLambdaFunction.Outputs.LambdaFunctionArn
  CarnationStateMachineArn:
    Description: Carnation State Machine Arn
    Value: !GetAtt CarnationStateMachine.Arn
  CarnationLambdaInvocationsAlarmArn:
    Description: Carnation Lambda Invocations Alarm Arn 
    Value: !GetAtt CarnationCloudWatchAlarms.Outputs.CloudWatchAlarmLambdaInvocationsArn
  CarnationLambdaErrorsAlarmArn:
    Description: Carnation Lambda Errors Alarm Arn 
    Value: !GetAtt CarnationCloudWatchAlarms.Outputs.CloudWatchAlarmLambdaErrorsArn
  CarnationLambdaThrottlesAlarmArn:
    Description: Carnation Lambda Throttles Alarm Arn 
    Value: !GetAtt CarnationCloudWatchAlarms.Outputs.CloudWatchAlarmLambdaThrottlesArn
  CarnationLambdaDurationAlarmArn:
    Description: Carnation Lambda Duration Alarm Arn 
    Value: !GetAtt CarnationCloudWatchAlarms.Outputs.CloudWatchAlarmLambdaDurationArn
  CarnationSLambdaConcurrentExecutionsAlarmArn:
    Description: Carnation Lambda Concurrent Executions Alarm Arn 
    Value: !GetAtt CarnationCloudWatchAlarms.Outputs.CloudWatchAlarmLambdaConurrentExecutionsArn
